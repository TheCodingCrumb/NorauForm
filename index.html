<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion Google</title>

  <!-- Vue.js -->
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- Config locale -->
  <script src="./config.js"></script>
</head>

<body class="bg-gray-100 flex items-center justify-center min-h-screen">
  <div id="app" class="bg-white p-8 rounded-2xl shadow-lg w-[400px] text-center">
    <h1 class="text-2xl font-bold mb-6">Connexion Google</h1>

    <div v-if="!user">
      <div id="g_id_signin"></div>
    </div>

    <div v-else>
      <h2 class="text-xl font-semibold mb-2">{{ user.name }}</h2>
      <p class="text-gray-600 mb-4">{{ user.email }}</p>
      <button
        @click="logout"
        class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600"
      >
        D√©connexion
      </button>
    </div>
  <script>
    const { createApp } = Vue;

    function initVue() {
      createApp({
        data() {
          return { user: null };
        },
        mounted() {
          const clientId = window.APP_CONFIG?.GOOGLE_CLIENT_ID;
          if (!clientId) {
            alert("‚ùå GOOGLE_CLIENT_ID manquant dans config.js !");
            return;
          }

          google.accounts.id.initialize({
            client_id: clientId,
            callback: this.handleCredentialResponse,
          });

          google.accounts.id.renderButton(
            document.getElementById("g_id_signin"),
            { theme: "outline", size: "large" }
          );
        },
        methods: {
          handleCredentialResponse(response) {
            const data = JSON.parse(atob(response.credential.split('.')[1]));
            this.user = {
              name: data.name,
              email: data.email,
            };
          },
          logout() {
            // D√©sactive la connexion automatique
            google.accounts.id.disableAutoSelect();

            // Efface l'utilisateur
            this.user = null;

            // Supprime la session locale
            localStorage.removeItem("google_user");

            // Attendre que Vue recr√©e le div
            this.$nextTick(() => {
              const signInDiv = document.getElementById("g_id_signin");
              if (signInDiv) {
                signInDiv.innerHTML = ""; // vide l'ancien contenu
                google.accounts.id.renderButton(signInDiv, {
                  theme: "outline",
                  size: "large"
                });
              }
            });
          }
        },
      }).mount("#app");
    }

    // üîí S‚Äôassurer que config.js est bien charg√© avant Vue
    if (window.APP_CONFIG?.GOOGLE_CLIENT_ID) {
      initVue();
    } else {
      // Si config.js charge apr√®s ce script
      window.addEventListener("load", () => {
        if (window.APP_CONFIG?.GOOGLE_CLIENT_ID) initVue();
        else alert("‚ùå Impossible de charger config.js !");
      });
    }
  </script>
</body>
</html>
